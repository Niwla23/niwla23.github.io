__NUXT_JSONP__("/posts/gateautomation", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq,ar,as,at,au){return {data:[{article:{slug:"gateautomation",description:E,title:"Handysteuerung Tor",image:"gateautomation.jpg",tags:["app","openhab","software","hardware","esp","esp32","embedded","loeten","iot"],toc:[],body:{type:R,children:[{type:b,tag:j,props:{},children:[{type:a,value:E}]},{type:a,value:h},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Das Tor hat eine Fernbedienung, die nur einen Knopf hat. Dieser Knopf führt eine der folgenden Aktionen aus:"}]},{type:a,value:h},{type:b,tag:"ul",props:{},children:[{type:a,value:h},{type:b,tag:F,props:{},children:[{type:a,value:"Auf"}]},{type:a,value:h},{type:b,tag:F,props:{},children:[{type:a,value:"Zu"}]},{type:a,value:h},{type:b,tag:F,props:{},children:[{type:a,value:"Stopp"}]},{type:a,value:h}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Wobei sich das Tor immer in die entgegengesetzte Richtung bewegt in die es sich beim letzten Mal bewegt hat. Den Knopf habe ich zuerst mit Fischertechnik Pneumatik und einem ESP32 gestuert. Später habe ich die Pneumatik durch einen Servo ausgetauscht.\nDas Tor lässt sich so schon steuern, man weiß aber nicht in welchem Zustand es sich gerade befindet."}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Meine erste Idee war einen ESP32 mit Ultraschallsensor am Tor anzubringen, der den Abstand misst."}]},{type:a,value:h},{type:b,tag:"blockquote",props:{},children:[{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Problem: kein WLAN"}]},{type:a,value:h}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Zuffälligerweise lag zwischen Keller und Tor ein altes Postkabel. Nach einem halben Tag messen hatte ich dann alle Adern zugeordnet.\nIch musste also nur noch den Ultraschallsensor an das Kabel löten, einen ESP an der anderen Seite anbringen und ein Gehäuse für den Sensor drucken.\nDas ganze sieht dann so aus:"}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Bild: Ultraschallsensor"}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Bild: ESP32"}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Um das ganze mit einem Slider in openHAB steuern zu können, habe ich eine Regel erstellt, die das Tor in die gewünscht Position fährt.\nDiese regel wird ausgeführt, wenn der Tor Slider einen Befehlt erhält."}]},{type:a,value:h},{type:b,tag:G,props:{className:[H]},children:[{type:b,tag:I,props:{},children:[{type:b,tag:u,props:{className:[J,"python"]},children:[{type:b,tag:c,props:{className:[g]},children:[{type:a,value:S}]},{type:a,value:" time\n"},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:"from"}]},{type:a,value:" org.slf4j "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:S}]},{type:a,value:" LoggerFactory\n\nlogger = LoggerFactory.getLogger("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"de.niwla23.automation.gate\""}]},{type:a,value:T},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"Starting gate check\""}]},{type:a,value:")\n\nlogger.info("},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:v}]},{type:a,value:w},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:U}]},{type:a,value:").state))\n"},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:e},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:v}]},{type:a,value:w},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:U}]},{type:a,value:").state) != "},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"OFF\""}]},{type:a,value:":\n  exit("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:V},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:x}]},{type:a,value:e},{type:b,tag:c,props:{className:[y,z]},children:[{type:a,value:"invert_position"}]},{type:a,value:q},{type:b,tag:c,props:{className:["hljs-params"]},children:[{type:a,value:"pos"}]},{type:a,value:"):\n    "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:K}]},{type:a,value:e},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"100"}]},{type:a,value:" - pos\n\n\ntarget = "},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:W}]},{type:a,value:q},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:X}]},{type:a,value:q},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:v}]},{type:a,value:w},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"gate\""}]},{type:a,value:").state)))\nlogger.info("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"Target value\""}]},{type:a,value:", target)\n\n"},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:x}]},{type:a,value:e},{type:b,tag:c,props:{className:[y,z]},children:[{type:a,value:"get_current"}]},{type:a,value:Y},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:K}]},{type:a,value:" invert_position("},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:W}]},{type:a,value:q},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:X}]},{type:a,value:q},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:v}]},{type:a,value:w},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"gate_status\""}]},{type:a,value:").state))))\n\n\n"},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:x}]},{type:a,value:e},{type:b,tag:c,props:{className:[y,z]},children:[{type:a,value:"is_ok"}]},{type:a,value:Y},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:K}]},{type:a,value:" get_current() "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:"in"}]},{type:a,value:e},{type:b,tag:c,props:{className:[l]},children:[{type:a,value:"range"}]},{type:a,value:"(target - "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:r}]},{type:a,value:", target + "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:r}]},{type:a,value:V},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:x}]},{type:a,value:e},{type:b,tag:c,props:{className:[y,z]},children:[{type:a,value:"press_button"}]},{type:a,value:"():\n    events.sendCommand("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"'gate_button'"}]},{type:a,value:L},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:Z}]},{type:a,value:")\n\n\n"},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:" is_ok():\n    logger.info("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"position is already ok\""}]},{type:a,value:")\n    exit("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:_},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:"else"}]},{type:a,value:":\n    events.sendCommand("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:$}]},{type:a,value:L},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:Z}]},{type:a,value:")\n    logger.info("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"position is not ok, starting...\""}]},{type:a,value:")\n    press_button()\n    time.sleep("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:r}]},{type:a,value:")\n    "},{type:b,tag:c,props:{className:[M]},children:[{type:a,value:"# keep checking if posititon reached press button again"}]},{type:a,value:k},{type:b,tag:c,props:{className:[M]},children:[{type:a,value:"# when position is 0 or 100 press button again."}]},{type:a,value:k},{type:b,tag:c,props:{className:[M]},children:[{type:a,value:"# cancel after 10 pushes to prevent gate from going crazy in case of sensor failure"}]},{type:a,value:"\n    iterations = "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:"\n    pushes = "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:"\n    \n    "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:"while"}]},{type:a,value:e},{type:b,tag:c,props:{className:["hljs-literal"]},children:[{type:a,value:"True"}]},{type:a,value:":\n        "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:" pushes \u003E "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"10"}]},{type:a,value:":\n          "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:N}]},{type:a,value:"\n        iterations = iterations + "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:A}]},{type:a,value:O},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:" is_ok():\n            "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:aa},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"94"}]},{type:a,value:e},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:P}]},{type:a,value:ab},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"8"}]},{type:a,value:":\n              "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:N}]},{type:a,value:"\n            pushes += "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:A}]},{type:a,value:"\n            press_button()\n            "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:N}]},{type:a,value:O},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:" iterations \u003E "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"90"}]},{type:a,value:":\n            pushes += "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:A}]},{type:a,value:"\n            press_button()\n            iterations = "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:"\n            "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:"continue"}]},{type:a,value:"\n        current = get_current()\n        "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:" current \u003E "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:ac}]},{type:a,value:e},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:P}]},{type:a,value:" current \u003C "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:ad}]},{type:a,value:":\n            logger.info("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"gate is fully open \u002F closed\""}]},{type:a,value:")\n            time.sleep("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:r}]},{type:a,value:")\n            "},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:n}]},{type:a,value:aa},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:ac}]},{type:a,value:e},{type:b,tag:c,props:{className:[g]},children:[{type:a,value:P}]},{type:a,value:ab},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:ad}]},{type:a,value:":\n                logger.info("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"gate is still fully open \u002F closed, pressing button.\""}]},{type:a,value:")\n                pushes += "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:A}]},{type:a,value:"\n                press_button()\n                iterations = "},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:o}]},{type:a,value:"\n                time.sleep("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:r}]},{type:a,value:")\n        time.sleep("},{type:b,tag:c,props:{className:[i]},children:[{type:a,value:"1.5"}]},{type:a,value:T},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"position is ok now, exiting...\""}]},{type:a,value:")\nevents.sendCommand("},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:$}]},{type:a,value:L},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"'OFF'"}]},{type:a,value:_}]}]}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Diese Regel ändert das Label vom Slider wenn sich der "},{type:b,tag:u,props:{},children:[{type:a,value:"working"}]},{type:a,value:" Zustand vom Tor ändert. Dieser verhindert, dass die Steuerungsregel doppelt läuft\nwas zu ziemlichem Chaos führt.\nDer pushes \u003E 10 Check verhindert das in dem Fall, dass der Sensor kapput geht alle paar Sekunden der Knopf gedrückt wird was bei gleichzeitigem\nAusfall der VPN Verbindung außerhalb des Netzwerks nicht mehr zu stoppen wäre."}]},{type:a,value:h},{type:b,tag:G,props:{className:[H]},children:[{type:b,tag:I,props:{},children:[{type:b,tag:u,props:{className:[J,ae]},children:[{type:b,tag:c,props:{className:[f]},children:[{type:a,value:af}]},{type:a,value:B},{type:b,tag:c,props:{className:[s]},children:[{type:a,value:t}]},{type:a,value:e},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:C}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:ag}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:D}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ah}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate_working"}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:"state:"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:Q}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ai}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:Q}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:aj}]},{type:a,value:h},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ak}]},{type:a,value:al},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:am}]},{type:a,value:B},{type:b,tag:c,props:{className:[s]},children:[{type:a,value:t}]},{type:a,value:e},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:an}]},{type:a,value:ao},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:C}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:ap}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:D}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:aq}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ar}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate.label"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"="}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\"Tor (\""}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:as}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate_working.state.toString"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:as}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"\")\""}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:at}]},{type:a,value:h}]}]}]},{type:a,value:h},{type:b,tag:j,props:{},children:[{type:a,value:"Diese Regel, der gate proxy updater setzt den Wert vom Tor Controlslider auf den invertierten Wert vom Sensor."}]},{type:a,value:h},{type:b,tag:G,props:{className:[H]},children:[{type:b,tag:I,props:{},children:[{type:b,tag:u,props:{className:[J,ae]},children:[{type:b,tag:c,props:{className:[f]},children:[{type:a,value:af}]},{type:a,value:B},{type:b,tag:c,props:{className:[s]},children:[{type:a,value:t}]},{type:a,value:e},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:C}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:ag}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:D}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ah}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate_status"}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ai}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:Q}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:aj}]},{type:a,value:h},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ak}]},{type:a,value:al},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:am}]},{type:a,value:B},{type:b,tag:c,props:{className:[s]},children:[{type:a,value:t}]},{type:a,value:e},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:an}]},{type:a,value:ao},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:C}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:ap}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:D}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:aq}]},{type:a,value:m},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:ar}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"if(gate.state"}]},{type:a,value:e},{type:b,tag:c,props:{className:["hljs-type"]},children:[{type:a,value:"!="}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate_status.state)"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate.postUpdate((100"}]},{type:a,value:e},{type:b,tag:c,props:{className:[s]},children:[{type:a,value:t}]},{type:a,value:O},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"gate_status.state"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"as"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:"DecimalType).toString)"}]},{type:a,value:k},{type:b,tag:c,props:{className:[f]},children:[{type:a,value:p}]},{type:a,value:e},{type:b,tag:c,props:{className:[d]},children:[{type:a,value:at}]},{type:a,value:h}]}]}]}]},excerpt:{type:R,children:[{type:b,tag:j,props:{},children:[{type:a,value:E}]}]},dir:"\u002Fposts",path:"\u002Fposts\u002Fgateautomation",extension:".md",createdAt:au,updatedAt:au},_img:{"/_ipx/s_1280x584/postthumbs/gateautomation.jpg":"\u002F_nuxt\u002Fimage\u002Fce717d.jpg"}}],fetch:{},mutations:void 0}}("text","element","span","hljs-string"," ","hljs-attr","hljs-keyword","\n","hljs-number","p","\n    ","hljs-built_in","\n      ","if","0","type:","(","5","hljs-bullet","-","code","str","(ir.getItem(","def","hljs-title","function_","1","\n  ","id:","configuration:","Mit einem Ultraschallsensor, einem alten Post Kabel und einem Servo habe ich unser Gartentor smart gemacht.","li","div","nuxt-content-highlight","pre","hljs","return",", ","hljs-comment","break","\n        ","or","\"\"","root","import",")\nlogger.info(","\"gate_working\"",")\n\n","int","float","():\n    ","'ON'",")\n","'gate_working'"," get_current() \u003E "," get_current() \u003C ","98","2","yaml","triggers:","\"1\"","itemName:","previousState:","core.ItemStateChangeTrigger","conditions:"," []\n","actions:","inputs:"," {}\n    ","\"2\"","application\u002Fvnd.openhab.dsl.rule","script:","+","script.ScriptAction","2022-05-29T19:43:22.286Z")));